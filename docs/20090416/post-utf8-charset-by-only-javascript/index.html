
<html>
<head>
<title>JavaScript だけで Shift_JIS/EUC-JP のページから UTF-8 に変換して POST する方法 - OTCHY.NET</title>
<link rel=stylesheet href=//cdnjs.cloudflare.com/ajax/libs/mini.css/3.0.1/mini-default.min.css>
<meta name=viewport content="width=device-width,initial-scale=1">
<style>:root{--back-color:#fff}.prev{text-align:left}.prev::before{transform:rotateZ(180deg)}.next{text-align:right}.next::after,.prev::before{display:inline-block;content:"➤"}</style>
</head>
<body>
<header class="sticky row">
<div class="col-sm-12 col-md-10 col-md-offset-1">
<a href=/ class=button>Home</a>
<a href=/javascript/ class=button>JavaScript</a>
<a href=/greasemonkey/ class=button>Greasemonkey</a>
<a href=/php/ class=button>PHP</a>
</div>
</header>
<main class=container>
<div class=row>
<div class="col-sm-12 col-md-10 col-md-offset-1">
<h1>JavaScript だけで Shift_JIS/EUC-JP のページから UTF-8 に変換して POST する方法</h1>
<hr>
</div>
</div>
<div class=row>
<div class="col-sm-12 col-md-10 col-md-offset-1">
<a href=http://www.otchy.net/20090416/bookmarklet-for-twitter/ >1 個前のエントリ</a>で、JavaScript だけを用いて、任意の文字コードのページから、UTF-8 エンコーディングで任意のサーバに (クロスドメインして) POST する方法を編み出しました。<br>
その部分だけで需要があるのではないかと思ったので、関数として取り出して公開します。<br>
<br>
案外スマートに書けたのでご機嫌です。<br>
<br>
<pre>function postUtf8(param)
    if (!param) return;
    param = param.replace(new RegExp('&', 'g'), '&ampamp;');
    param = param.replace(new RegExp('"', 'g'), '&ampquot;');
    param = param.replace(new RegExp('&lt;', 'g'), '&amplt;');
    param = param.replace(new RegExp('>', 'g'), '&ampgt;');
    var d = document;
    var i = d.createElement('iframe');
    i.style.display = 'none';
    d.body.appendChild(i);
    var iDoc = i.contentWindow.document;
    iDoc.open();
    iDoc.write('&lt;form method="POST" action="http://server/path/file">');
    iDoc.write('&lt;input type="hidden" name="param" value="' + param + '" />');
    iDoc.write('&lt;/form>');
    iDoc.write('&lt;script>window.onload = function(){document.forms[0].submit();}&lt;/script>');
    iDoc.close();
    setTimeout(function() {
        d.body.removeChild(i);
    }, 5000);
}</pre>
<br>
こんな感じです。<br>
http://server... と、param の部分を書き換えれば、好きなサーバに好きなパラメータを渡せますね。<br>
POST 先のサーバが重い時は、setTimeout の 5000 の値をもう少し大きめに取った方がいいかもしれません。<br>
<br>
簡単に技術的な説明もしておきましょうか。<br>
基本的には、iframe を新規で作成すると、その文字コードがデフォルトで UTF-8 として処理される事を利用しています。<br>
<br>
iframe の中身は当初 DOM で構築しようとしたのですが、うまくいかず、document.write で構築しています。<br>
<br>
iframe 内で window.onload しているのは、これまた直接 script タグ内で submit しようとすると、その時点では iframe の DOM 構築が完了しておらず、submit 出来ないためです。<br>
iDoc.close(); しないと、DOM が構築されないのではないかと予想されます。<br>
</div>
</div>
<div class=row>
<div class="col-sm-12 col-md-10 col-md-offset-1">
<hr>
カテゴリ:
<a href=/category/dev/ >Development</a>
タグ:
<a href=/tag/utf-8/ >utf-8</a>
<a href=/tag/javascript/ >javascript</a>
</div>
</div>
<div class=row>
<div class="col-sm-12 col-md-10 col-md-offset-1">
<hr>
</div>
<div class="col-sm-12 col-md-10 col-md-offset-1 col-lg-5 col-lg-offset-1 prev">
<a href=/20090416/bookmarklet-for-twitter/ >閲覧中のページについてそこから遷移せずTwitterでつぶやくためのブックマークレット</a>
</div>
<div class="col-sm-12 col-md-10 col-md-offset-1 col-lg-5 col-lg-offset-0 next">
<a href=/20090419/google-app-engine-java-development-in-usb-memory-1/ >Google App Engine for Java 開発環境を USB メモリで持ち歩く (1)</a>
</div>
</div>
</main>
<footer>
<div class="col-sm-12 col-md-10 col-md-offset-1">
Copyright © OTCHY.NET authored by <a href=https://twitter.com/otchy target=_blank>@otchy</a>
</div>
</footer>
</body>
</html>
